<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPOD Configuration Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .config-section {
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
        }
        .config-section h4 {
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .btn-group-vertical .btn {
            margin-bottom: 0.25rem;
        }
        .validation-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .validation-success {
            color: #28a745;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .item-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }
        .item-card:hover {
            background-color: #e9ecef;
        }
        .status-badge {
            font-size: 0.75rem;
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
        }
        .sidebar {
            background-color: #f8f9fa;
            min-height: 100vh;
            padding: 1rem;
        }
        .main-content {
            padding: 1rem;
        }
        .config-preview {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Боковая панель -->
            <div class="col-md-3 sidebar">
                <h3 class="mb-4">
                    <i class="fas fa-cogs text-primary"></i>
                    SPOD Config Manager
                </h3>
                
                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-outline-primary" onclick="loadConfig()">
                        <i class="fas fa-sync"></i> Загрузить конфигурацию
                    </button>
                    <button class="btn btn-outline-success" onclick="exportConfig()">
                        <i class="fas fa-download"></i> Экспорт
                    </button>
                    <button class="btn btn-outline-info" onclick="importConfig()">
                        <i class="fas fa-upload"></i> Импорт
                    </button>
                </div>

                <div class="mb-4">
                    <input type="file" id="importFile" accept=".py" style="display: none;" onchange="handleFileImport()">
                </div>

                <div class="list-group">
                    <a href="#input-files" class="list-group-item list-group-item-action" onclick="showSection('input-files')">
                        <i class="fas fa-file-alt"></i> Входные файлы
                    </a>
                    <a href="#merge-fields" class="list-group-item list-group-item-action" onclick="showSection('merge-fields')">
                        <i class="fas fa-link"></i> Правила объединения
                    </a>
                    <a href="#merge-advanced" class="list-group-item list-group-item-action" onclick="showSection('merge-advanced')">
                        <i class="fas fa-magic"></i> Расширенные правила
                    </a>
                    <a href="#check-duplicates" class="list-group-item list-group-item-action" onclick="showSection('check-duplicates')">
                        <i class="fas fa-search"></i> Проверка дублей
                    </a>
                    <a href="#color-scheme" class="list-group-item list-group-item-action" onclick="showSection('color-scheme')">
                        <i class="fas fa-palette"></i> Цветовая схема
                    </a>
                    <a href="#summary-sheet" class="list-group-item list-group-item-action" onclick="showSection('summary-sheet')">
                        <i class="fas fa-table"></i> Сводный лист
                    </a>
                    <a href="#json-columns" class="list-group-item list-group-item-action" onclick="showSection('json-columns')">
                        <i class="fas fa-code"></i> JSON колонки
                    </a>
                    <a href="#field-validations" class="list-group-item list-group-item-action" onclick="showSection('field-validations')">
                        <i class="fas fa-check-circle"></i> Валидация полей
                    </a>
                </div>
            </div>

            <!-- Основной контент -->
            <div class="col-md-9 main-content">
                <div id="loading" class="text-center" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                </div>

                <!-- Секция входных файлов -->
                <div id="input-files-section" class="config-section" style="display: none;">
                    <h4><i class="fas fa-file-alt"></i> Входные файлы</h4>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-primary" id="input-files-count">0 файлов</span>
                        <button class="btn btn-success btn-sm" onclick="addInputFile()">
                            <i class="fas fa-plus"></i> Добавить файл
                        </button>
                    </div>
                    <div id="input-files-list"></div>
                </div>

                <!-- Секция правил объединения -->
                <div id="merge-fields-section" class="config-section" style="display: none;">
                    <h4><i class="fas fa-link"></i> Правила объединения</h4>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-primary" id="merge-fields-count">0 правил</span>
                        <button class="btn btn-success btn-sm" onclick="addMergeField()">
                            <i class="fas fa-plus"></i> Добавить правило
                        </button>
                    </div>
                    <div id="merge-fields-list"></div>
                </div>

                <!-- Секция расширенных правил -->
                <div id="merge-advanced-section" class="config-section" style="display: none;">
                    <h4><i class="fas fa-magic"></i> Расширенные правила объединения</h4>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-primary" id="merge-advanced-count">0 правил</span>
                        <button class="btn btn-success btn-sm" onclick="addAdvancedMergeField()">
                            <i class="fas fa-plus"></i> Добавить правило
                        </button>
                    </div>
                    <div id="merge-advanced-list"></div>
                </div>

                <!-- Секция проверки дублей -->
                <div id="check-duplicates-section" class="config-section" style="display: none;">
                    <h4><i class="fas fa-search"></i> Проверка дублей</h4>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-primary" id="check-duplicates-count">0 правил</span>
                        <button class="btn btn-success btn-sm" onclick="addCheckDuplicate()">
                            <i class="fas fa-plus"></i> Добавить правило
                        </button>
                    </div>
                    <div id="check-duplicates-list"></div>
                </div>

                <!-- Секция цветовой схемы -->
                <div id="color-scheme-section" class="config-section" style="display: none;">
                    <h4><i class="fas fa-palette"></i> Цветовая схема</h4>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-primary" id="color-scheme-count">0 правил</span>
                        <button class="btn btn-success btn-sm" onclick="addColorScheme()">
                            <i class="fas fa-plus"></i> Добавить правило
                        </button>
                    </div>
                    <div id="color-scheme-list"></div>
                </div>

                <!-- Секция сводного листа -->
                <div id="summary-sheet-section" class="config-section" style="display: none;">
                    <h4><i class="fas fa-table"></i> Сводный лист</h4>
                    <div id="summary-sheet-config"></div>
                </div>

                <!-- Секция JSON колонок -->
                <div id="json-columns-section" class="config-section" style="display: none;">
                    <h4><i class="fas fa-code"></i> JSON колонки</h4>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-primary" id="json-columns-count">0 правил</span>
                        <button class="btn btn-success btn-sm" onclick="addJsonColumn()">
                            <i class="fas fa-plus"></i> Добавить правило
                        </button>
                    </div>
                    <div id="json-columns-list"></div>
                </div>

                <!-- Секция валидации полей -->
                <div id="field-validations-section" class="config-section" style="display: none;">
                    <h4><i class="fas fa-check-circle"></i> Валидация полей</h4>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="badge bg-primary" id="field-validations-count">0 правил</span>
                        <button class="btn btn-success btn-sm" onclick="addFieldValidation()">
                            <i class="fas fa-plus"></i> Добавить правило
                        </button>
                    </div>
                    <div id="field-validations-list"></div>
                </div>

                <!-- Превью конфигурации -->
                <div id="preview-section" class="config-section" style="display: none;">
                    <h4><i class="fas fa-eye"></i> Превью конфигурации</h4>
                    <div class="config-preview" id="config-preview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal fade" id="inputFileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Настройка входного файла</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="inputFileForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Имя файла</label>
                                <input type="text" class="form-control" name="file" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Имя листа</label>
                                <input type="text" class="form-control" name="sheet" required>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Максимальная ширина</label>
                                <input type="number" class="form-control" name="max_col_width" value="100">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Закрепление</label>
                                <input type="text" class="form-control" name="freeze" placeholder="C2">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Режим ширины</label>
                                <select class="form-select" name="col_width_mode">
                                    <option value="AUTO">AUTO</option>
                                    <option value="FIXED">FIXED</option>
                                    <option value="MIN">MIN</option>
                                    <option value="MAX">MAX</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Минимальная ширина</label>
                                <input type="number" class="form-control" name="min_col_width" value="8">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveInputFile()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="mergeFieldModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Настройка правила объединения</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="mergeFieldForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Источник</label>
                                <select class="form-select" name="sheet_src" required>
                                    <option value="">Выберите лист</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Целевой лист</label>
                                <select class="form-select" name="sheet_dst" required>
                                    <option value="">Выберите лист</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Ключи источника (через запятую)</label>
                                <input type="text" class="form-control" name="src_key" placeholder="CONTEST_CODE,TOURNAMENT_CODE">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ключи цели (через запятую)</label>
                                <input type="text" class="form-control" name="dst_key" placeholder="CONTEST_CODE,TOURNAMENT_CODE">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Колонки (через запятую)</label>
                                <input type="text" class="form-control" name="column" placeholder="FULL_NAME,BUSINESS_STATUS">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Режим</label>
                                <select class="form-select" name="mode">
                                    <option value="value">value</option>
                                    <option value="count">count</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="multiply_rows">
                                    <label class="form-check-label">Размножать строки</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Максимальная ширина</label>
                                <input type="number" class="form-control" name="col_max_width" value="80">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Минимальная ширина</label>
                                <input type="number" class="form-control" name="col_min_width" value="8">
                            </div>
                        </div>
                        
                        <!-- Расширенные настройки -->
                        <div class="mt-4">
                            <h6>Расширенные настройки</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Фильтр по статусам (JSON)</label>
                                    <textarea class="form-control" name="status_filters" rows="3" placeholder='{"TOURNAMENT_STATUS": ["АКТИВНЫЙ", "ЗАВЕРШЕН"]}'></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Пользовательские условия (JSON)</label>
                                    <textarea class="form-control" name="custom_conditions" rows="3" placeholder='{"CONTEST_TYPE": ["INDIVIDUAL", "TEAM"]}'></textarea>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label class="form-label">Группировка (через запятую)</label>
                                    <input type="text" class="form-control" name="group_by" placeholder="CONTEST_TYPE,BUSINESS_BLOCK">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Агрегация (JSON)</label>
                                    <textarea class="form-control" name="aggregate" rows="2" placeholder='{"SCORE": "sum", "RANK": "min"}'></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveMergeField()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentConfig = {};
        let currentSection = '';
        let editingIndex = -1;

        // Загрузка конфигурации при старте
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
        });

        async function loadConfig() {
            showLoading(true);
            try {
                const response = await fetch('/api/config');
                currentConfig = await response.json();
                updateCounts();
                showSection('input-files');
            } catch (error) {
                console.error('Ошибка загрузки конфигурации:', error);
                alert('Ошибка загрузки конфигурации');
            } finally {
                showLoading(false);
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showSection(section) {
            // Скрываем все секции
            document.querySelectorAll('.config-section').forEach(el => {
                el.style.display = 'none';
            });
            
            // Показываем выбранную секцию
            document.getElementById(section + '-section').style.display = 'block';
            currentSection = section;
            
            // Обновляем активную ссылку в боковой панели
            document.querySelectorAll('.list-group-item').forEach(el => {
                el.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Загружаем данные секции
            loadSectionData(section);
        }

        function loadSectionData(section) {
            switch(section) {
                case 'input-files':
                    loadInputFiles();
                    break;
                case 'merge-fields':
                    loadMergeFields();
                    break;
                case 'merge-advanced':
                    loadAdvancedMergeFields();
                    break;
                case 'check-duplicates':
                    loadCheckDuplicates();
                    break;
                case 'color-scheme':
                    loadColorScheme();
                    break;
                case 'summary-sheet':
                    loadSummarySheet();
                    break;
                case 'json-columns':
                    loadJsonColumns();
                    break;
                case 'field-validations':
                    loadFieldValidations();
                    break;
            }
        }

        function loadInputFiles() {
            const container = document.getElementById('input-files-list');
            container.innerHTML = '';
            
            currentConfig.input_files.forEach((file, index) => {
                const card = createInputFileCard(file, index);
                container.appendChild(card);
            });
        }

        function createInputFileCard(file, index) {
            const div = document.createElement('div');
            div.className = 'item-card';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6>${file.file || 'Без имени'}</h6>
                        <p class="mb-1"><strong>Лист:</strong> ${file.sheet || 'Не указан'}</p>
                        <p class="mb-1"><strong>Ширина:</strong> ${file.max_col_width || 'Не указана'}</p>
                        <p class="mb-1"><strong>Закрепление:</strong> ${file.freeze || 'Не указано'}</p>
                    </div>
                    <div class="btn-group-vertical">
                        <button class="btn btn-sm btn-outline-primary" onclick="editInputFile(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInputFile(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            return div;
        }

        function addInputFile() {
            editingIndex = -1;
            document.getElementById('inputFileForm').reset();
            new bootstrap.Modal(document.getElementById('inputFileModal')).show();
        }

        function editInputFile(index) {
            editingIndex = index;
            const file = currentConfig.input_files[index];
            
            // Заполняем форму
            document.querySelector('#inputFileForm input[name="file"]').value = file.file || '';
            document.querySelector('#inputFileForm input[name="sheet"]').value = file.sheet || '';
            document.querySelector('#inputFileForm input[name="max_col_width"]').value = file.max_col_width || 100;
            document.querySelector('#inputFileForm input[name="freeze"]').value = file.freeze || '';
            document.querySelector('#inputFileForm select[name="col_width_mode"]').value = file.col_width_mode || 'AUTO';
            document.querySelector('#inputFileForm input[name="min_col_width"]').value = file.min_col_width || 8;
            
            new bootstrap.Modal(document.getElementById('inputFileModal')).show();
        }

        function saveInputFile() {
            const form = document.getElementById('inputFileForm');
            const formData = new FormData(form);
            const fileData = Object.fromEntries(formData.entries());
            
            // Преобразуем числовые поля
            fileData.max_col_width = parseInt(fileData.max_col_width);
            fileData.min_col_width = parseInt(fileData.min_col_width);
            
            if (editingIndex === -1) {
                currentConfig.input_files.push(fileData);
            } else {
                currentConfig.input_files[editingIndex] = fileData;
            }
            
            updateConfig('input_files', currentConfig.input_files);
            loadInputFiles();
            updateCounts();
            
            bootstrap.Modal.getInstance(document.getElementById('inputFileModal')).hide();
        }

        function deleteInputFile(index) {
            if (confirm('Удалить этот файл?')) {
                currentConfig.input_files.splice(index, 1);
                updateConfig('input_files', currentConfig.input_files);
                loadInputFiles();
                updateCounts();
            }
        }

        function loadMergeFields() {
            const container = document.getElementById('merge-fields-list');
            container.innerHTML = '';
            
            currentConfig.merge_fields.forEach((field, index) => {
                const card = createMergeFieldCard(field, index);
                container.appendChild(card);
            });
        }

        function createMergeFieldCard(field, index) {
            const div = document.createElement('div');
            div.className = 'item-card';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6>${field.sheet_src || 'Не указан'} → ${field.sheet_dst || 'Не указан'}</h6>
                        <p class="mb-1"><strong>Ключи:</strong> ${field.src_key?.join(', ') || 'Не указаны'} → ${field.dst_key?.join(', ') || 'Не указаны'}</p>
                        <p class="mb-1"><strong>Колонки:</strong> ${field.column?.join(', ') || 'Не указаны'}</p>
                        <p class="mb-1"><strong>Режим:</strong> ${field.mode || 'value'}</p>
                        ${field.status_filters ? `<p class="mb-1"><strong>Фильтры:</strong> ${JSON.stringify(field.status_filters)}</p>` : ''}
                    </div>
                    <div class="btn-group-vertical">
                        <button class="btn btn-sm btn-outline-primary" onclick="editMergeField(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMergeField(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            return div;
        }

        function addMergeField() {
            editingIndex = -1;
            document.getElementById('mergeFieldForm').reset();
            loadSheetsForSelects();
            new bootstrap.Modal(document.getElementById('mergeFieldModal')).show();
        }

        function editMergeField(index) {
            editingIndex = index;
            const field = currentConfig.merge_fields[index];
            
            // Заполняем форму
            document.querySelector('#mergeFieldForm select[name="sheet_src"]').value = field.sheet_src || '';
            document.querySelector('#mergeFieldForm select[name="sheet_dst"]').value = field.sheet_dst || '';
            document.querySelector('#mergeFieldForm input[name="src_key"]').value = Array.isArray(field.src_key) ? field.src_key.join(',') : field.src_key || '';
            document.querySelector('#mergeFieldForm input[name="dst_key"]').value = Array.isArray(field.dst_key) ? field.dst_key.join(',') : field.dst_key || '';
            document.querySelector('#mergeFieldForm input[name="column"]').value = Array.isArray(field.column) ? field.column.join(',') : field.column || '';
            document.querySelector('#mergeFieldForm select[name="mode"]').value = field.mode || 'value';
            document.querySelector('#mergeFieldForm input[name="multiply_rows"]').checked = field.multiply_rows || false;
            document.querySelector('#mergeFieldForm input[name="col_max_width"]').value = field.col_max_width || 80;
            document.querySelector('#mergeFieldForm input[name="col_min_width"]').value = field.col_min_width || 8;
            document.querySelector('#mergeFieldForm textarea[name="status_filters"]').value = field.status_filters ? JSON.stringify(field.status_filters, null, 2) : '';
            document.querySelector('#mergeFieldForm textarea[name="custom_conditions"]').value = field.custom_conditions ? JSON.stringify(field.custom_conditions, null, 2) : '';
            document.querySelector('#mergeFieldForm input[name="group_by"]').value = Array.isArray(field.group_by) ? field.group_by.join(',') : field.group_by || '';
            document.querySelector('#mergeFieldForm textarea[name="aggregate"]').value = field.aggregate ? JSON.stringify(field.aggregate, null, 2) : '';
            
            loadSheetsForSelects();
            new bootstrap.Modal(document.getElementById('mergeFieldModal')).show();
        }

        function saveMergeField() {
            const form = document.getElementById('mergeFieldForm');
            const formData = new FormData(form);
            const fieldData = Object.fromEntries(formData.entries());
            
            // Преобразуем массивы
            fieldData.src_key = fieldData.src_key ? fieldData.src_key.split(',').map(s => s.trim()) : [];
            fieldData.dst_key = fieldData.dst_key ? fieldData.dst_key.split(',').map(s => s.trim()) : [];
            fieldData.column = fieldData.column ? fieldData.column.split(',').map(s => s.trim()) : [];
            fieldData.group_by = fieldData.group_by ? fieldData.group_by.split(',').map(s => s.trim()) : null;
            
            // Преобразуем JSON поля
            try {
                if (fieldData.status_filters) {
                    fieldData.status_filters = JSON.parse(fieldData.status_filters);
                }
                if (fieldData.custom_conditions) {
                    fieldData.custom_conditions = JSON.parse(fieldData.custom_conditions);
                }
                if (fieldData.aggregate) {
                    fieldData.aggregate = JSON.parse(fieldData.aggregate);
                }
            } catch (e) {
                alert('Ошибка в JSON полях: ' + e.message);
                return;
            }
            
            // Преобразуем числовые поля
            fieldData.col_max_width = parseInt(fieldData.col_max_width);
            fieldData.col_min_width = parseInt(fieldData.col_min_width);
            fieldData.multiply_rows = fieldData.multiply_rows === 'on';
            
            if (editingIndex === -1) {
                currentConfig.merge_fields.push(fieldData);
            } else {
                currentConfig.merge_fields[editingIndex] = fieldData;
            }
            
            updateConfig('merge_fields', currentConfig.merge_fields);
            loadMergeFields();
            updateCounts();
            
            bootstrap.Modal.getInstance(document.getElementById('mergeFieldModal')).hide();
        }

        function deleteMergeField(index) {
            if (confirm('Удалить это правило?')) {
                currentConfig.merge_fields.splice(index, 1);
                updateConfig('merge_fields', currentConfig.merge_fields);
                loadMergeFields();
                updateCounts();
            }
        }

        async function loadSheetsForSelects() {
            try {
                const response = await fetch('/api/sheets');
                const sheets = await response.json();
                
                const srcSelect = document.querySelector('#mergeFieldForm select[name="sheet_src"]');
                const dstSelect = document.querySelector('#mergeFieldForm select[name="sheet_dst"]');
                
                srcSelect.innerHTML = '<option value="">Выберите лист</option>';
                dstSelect.innerHTML = '<option value="">Выберите лист</option>';
                
                sheets.forEach(sheet => {
                    const option1 = document.createElement('option');
                    option1.value = sheet;
                    option1.textContent = sheet;
                    srcSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = sheet;
                    option2.textContent = sheet;
                    dstSelect.appendChild(option2);
                });
            } catch (error) {
                console.error('Ошибка загрузки листов:', error);
            }
        }

        function updateCounts() {
            document.getElementById('input-files-count').textContent = `${currentConfig.input_files.length} файлов`;
            document.getElementById('merge-fields-count').textContent = `${currentConfig.merge_fields.length} правил`;
            document.getElementById('merge-advanced-count').textContent = `${currentConfig.merge_fields_advanced.length} правил`;
            document.getElementById('check-duplicates-count').textContent = `${currentConfig.check_duplicates.length} правил`;
            document.getElementById('color-scheme-count').textContent = `${currentConfig.color_scheme.length} правил`;
            document.getElementById('json-columns-count').textContent = `${Object.keys(currentConfig.json_columns).length} правил`;
            document.getElementById('field-validations-count').textContent = `${Object.keys(currentConfig.field_length_validations).length} правил`;
        }

        async function updateConfig(section, data) {
            try {
                const response = await fetch(`/api/config/${section}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error('Ошибка обновления конфигурации');
                }
            } catch (error) {
                console.error('Ошибка обновления:', error);
                alert('Ошибка обновления конфигурации');
            }
        }

        async function exportConfig() {
            try {
                const response = await fetch('/api/export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'spod_config.py';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Ошибка экспорта:', error);
                alert('Ошибка экспорта конфигурации');
            }
        }

        function importConfig() {
            document.getElementById('importFile').click();
        }

        async function handleFileImport() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/import', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`Конфигурация успешно импортирована. Импортированы секции: ${result.imported.join(', ')}`);
                    loadConfig();
                } else {
                    alert('Ошибка импорта: ' + result.error);
                }
            } catch (error) {
                console.error('Ошибка импорта:', error);
                alert('Ошибка импорта конфигурации');
            }
        }

        // Заглушки для остальных функций
        function loadAdvancedMergeFields() {
            document.getElementById('merge-advanced-list').innerHTML = '<p class="text-muted">Функция в разработке</p>';
        }

        function loadCheckDuplicates() {
            document.getElementById('check-duplicates-list').innerHTML = '<p class="text-muted">Функция в разработке</p>';
        }

        function loadColorScheme() {
            document.getElementById('color-scheme-list').innerHTML = '<p class="text-muted">Функция в разработке</p>';
        }

        function loadSummarySheet() {
            document.getElementById('summary-sheet-config').innerHTML = '<p class="text-muted">Функция в разработке</p>';
        }

        function loadJsonColumns() {
            document.getElementById('json-columns-list').innerHTML = '<p class="text-muted">Функция в разработке</p>';
        }

        function loadFieldValidations() {
            document.getElementById('field-validations-list').innerHTML = '<p class="text-muted">Функция в разработке</p>';
        }

        function addAdvancedMergeField() {
            alert('Функция в разработке');
        }

        function addCheckDuplicate() {
            alert('Функция в разработке');
        }

        function addColorScheme() {
            alert('Функция в разработке');
        }

        function addJsonColumn() {
            alert('Функция в разработке');
        }

        function addFieldValidation() {
            alert('Функция в разработке');
        }
    </script>
</body>
</html>
