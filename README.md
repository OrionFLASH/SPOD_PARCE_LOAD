# SPOD PROM - Система обработки и редактирования данных

## Содержание

1. [Общее описание](#общее-описание)
2. [Структура проекта](#структура-проекта)
3. [Программа main.py - Обработка данных](#программа-mainpy---обработка-данных)
4. [Админ-панель - Редактирование данных](#админ-панель---редактирование-данных)
5. [Техническое задание](#техническое-задание)
6. [Анализ входных данных](#анализ-входных-данных)
7. [Установка и запуск](#установка-и-запуск)
8. [Логирование](#логирование)
9. [История версий](#история-версий)

---

## Общее описание

Проект состоит из двух основных компонентов:

1. **main.py** - Основная программа обработки данных из CSV файлов SPOD системы
2. **admin_panel** - Веб-интерфейс для редактирования данных через браузер

Обе программы работают с одними и теми же исходными данными, но выполняют разные задачи:
- `main.py` - читает, обрабатывает, объединяет и записывает данные в Excel
- `admin_panel` - позволяет редактировать данные через удобный веб-интерфейс

---

## Структура проекта

```
SPOD_PARCE_LOAD/
├── main.py                 # Основная программа обработки
├── SPOD/                   # Исходные CSV файлы
├── OUT/                    # Результирующие Excel файлы
├── EDIT/                   # Копии файлов для редактирования (сессии)
├── BACKUP/                 # Резервные копии
├── LOGS/                   # Файлы логов
├── admin_panel/            # Админ-панель
│   ├── app.py             # Flask приложение
│   ├── config.py          # Конфигурация
│   ├── templates/         # HTML шаблоны
│   ├── static/            # CSS, JS, изображения
│   └── utils/             # Утилиты
│       ├── file_manager.py
│       ├── data_manager.py
│       └── json_editor.py
└── venv/                  # Виртуальное окружение
```

---

## Программа main.py - Обработка данных

### Назначение

Основная программа для обработки данных из CSV файлов системы SPOD. Программа:
- Читает CSV файлы из каталога `SPOD/`
- Обрабатывает данные согласно правилам объединения (`MERGE_FIELDS`)
- Проверяет дубликаты (`CHECK_DUPLICATES`)
- Создает итоговый Excel файл с несколькими листами
- Ведет подробное логирование всех операций

### Входные данные

Программа работает с 11 CSV файлами, определенными в `INPUT_FILES`:

1. **CONTEST-DATA** - Данные о конкурсах
2. **EMPLOYEE** - Данные о сотрудниках
3. **GROUP** - Группы
4. **INDICATOR** - Индикаторы
5. **ORG_UNIT_V20** - Организационные единицы
6. **REPORT** - Отчеты
7. **REWARD** - Награды
8. **REWARD-LINK** - Связи наград
9. **TOURNAMENT-SCHEDULE** - Расписание турниров
10. **TOURNAMENT-SCHEDULE-LINK** - Связи расписания
11. **TOURNAMENT-SCHEDULE-LINK_CONTEST** - Связи расписания с конкурсами

### Основная логика работы

#### 1. Инициализация и настройка

```python
# Настройка логирования
setup_logger()  # Создает логгер с двумя уровнями: DEBUG (файл) и INFO (консоль)

# Загрузка конфигурации
INPUT_FILES = [...]  # Список файлов для обработки
MERGE_FIELDS = [...]  # Правила объединения данных
CHECK_DUPLICATES = [...]  # Правила проверки дубликатов
```

#### 2. Чтение CSV файлов

```python
def read_csv_file(file_path):
    # Читает CSV с разделителем ";"
    # Обрабатывает кодировку UTF-8
    # Возвращает DataFrame
```

**Особенности:**
- Автоматическое определение файла по дате в имени
- Обработка различных форматов дат в именах файлов
- Пропуск некорректных строк (`on_bad_lines='skip'`)

#### 3. Обработка данных

##### 3.1. Объединение данных (MERGE_FIELDS)

Программа объединяет данные из разных файлов по правилам:

```python
MERGE_FIELDS = [
    {
        "sheet_src": "SOURCE_SHEET",    # Источник данных
        "sheet_dst": "DEST_SHEET",      # Целевой лист
        "src_key": "SOURCE_KEY",        # Ключ в источнике
        "dst_key": "DEST_KEY",          # Ключ в целевом листе
        "mode": "merge|count|sum",      # Режим объединения
        "fields": [...]                 # Поля для объединения
    }
]
```

**Режимы объединения:**
- `merge` - Объединение полей (добавление новых колонок)
- `count` - Подсчет количества записей
- `sum` - Суммирование значений

##### 3.2. Проверка дубликатов (CHECK_DUPLICATES)

```python
CHECK_DUPLICATES = [
    {
        "sheet": "SHEET_NAME",
        "key_cols": ["COL1", "COL2"],  # Колонки для проверки
        "color": "#FF0000"              # Цвет для дубликатов
    }
]
```

**Логика:**
- Находит записи с одинаковыми значениями в ключевых колонках
- Помечает дубликаты цветом
- Создает колонку "ДУБЛЬ: COL1_COL2_..." с метками

##### 3.3. Обработка JSON полей

Некоторые поля содержат JSON данные:
- `CONTEST_FEATURE` (CONTEST-DATA)
- `CONTEST_PERIOD` (CONTEST-DATA)
- `BUSINESS_BLOCK` (CONTEST-DATA)
- `TARGET_TYPE` (TOURNAMENT-SCHEDULE)
- `FILTER_PERIOD_ARR` (TOURNAMENT-SCHEDULE)
- `INDICATOR_FILTER` (INDICATOR)
- `GROUP_VALUE` (GROUP)
- `REWARD_ADD_DATA` (REWARD)

Эти поля обрабатываются как строки и сохраняются в исходном виде.

#### 4. Запись в Excel

```python
def write_to_excel(sheets_data, output_path):
    # Создает Excel файл с несколькими листами
    # Сохраняет порядок листов
    # Применяет цветовую схему для дубликатов
```

**Структура Excel файла:**
- Каждый исходный файл → отдельный лист
- Листы упорядочены согласно `ordered_sheets`
- Применяется цветовая схема для дубликатов

### Логирование

Программа ведет два уровня логирования:

1. **DEBUG** (в файл):
   - Все операции чтения/записи
   - Детали обработки данных
   - Ошибки с полным stack trace
   - Формат: `дата время - [DEBUG] - сообщение [class: ClassName | def: function_name]`

2. **INFO** (в консоль):
   - Основные этапы выполнения
   - Критические ошибки
   - Итоговая статистика

**Именование логов:**
- Формат: `LOGS_DEBUG_YYYYMMDD_HH_MM.log`
- Расположение: `LOGS/`

---

## Админ-панель - Редактирование данных

### Назначение

Веб-интерфейс для редактирования данных из CSV файлов через браузер. Позволяет:
- Просматривать данные всех файлов
- Редактировать записи
- Создавать новые записи
- Удалять записи
- Редактировать JSON поля
- Работать с несколькими сессиями редактирования

### Архитектура

#### Backend (Flask)

**app.py** - Основное Flask приложение:
- REST API для работы с данными
- Управление сессиями редактирования
- Обработка CRUD операций

**Основные endpoints:**
```
GET  /api/sessions              # Список сессий
POST /api/session/new           # Создание новой сессии
POST /api/session/<name>        # Переключение сессии
DELETE /api/session/<name>      # Удаление сессии
GET  /api/files                  # Список файлов
GET  /api/files/<key>/records   # Записи файла
GET  /api/files/<key>/records/<id>  # Одна запись
POST /api/files/<key>/records   # Создание записи
PUT  /api/files/<key>/records/<id>   # Обновление записи
DELETE /api/files/<key>/records/<id> # Удаление записи
```

**config.py** - Конфигурация:
- Динамическое чтение `INPUT_FILES` из `main.py`
- Определение JSON полей
- Зависимости между файлами
- Многострочные поля

**utils/file_manager.py** - Управление файлами:
- Чтение/запись CSV
- Управление сессиями (создание, удаление)
- Резервное копирование

**utils/data_manager.py** - Управление данными:
- CRUD операции
- Валидация данных
- Обработка JSON полей
- Проверка зависимостей

#### Frontend (HTML/CSS/JavaScript)

**templates/index.html** - Главная страница:
- Интерфейс с вкладками для файлов
- Формы редактирования
- Модальные окна для JSON редактора

**static/js/app.js** - Клиентская логика:
- Загрузка и отображение данных
- Управление сессиями
- CRUD операции через API
- JSON редактор

**static/css/style.css** - Стили:
- Современный дизайн
- Адаптивная верстка
- Цветовая схема

### Логика работы админ-панели

#### 1. Инициализация

При загрузке страницы:
1. Загружается список сессий из `EDIT/`
2. Выбирается последняя сессия (или создается новая)
3. Загружается список файлов из `main.py`
4. Создаются вкладки для каждого файла
5. Загружаются записи первого файла

#### 2. Управление сессиями

**Создание сессии:**
1. Создается каталог `EDIT/YYYYMMDD_HHMM/`
2. Копируются все файлы из `SPOD/`
3. Сессия добавляется в список
4. Автоматически выбирается как текущая

**Переключение сессии:**
1. Меняется `current_edit_dir` в `FileManager`
2. Перезагружаются данные
3. Обновляется интерфейс

**Удаление сессии:**
1. Проверяется что сессия не текущая
2. Удаляется каталог со всеми файлами
3. Обновляется список сессий

#### 3. Работа с данными

**Чтение записей:**
- Пагинация (по умолчанию 50 записей на страницу)
- Поиск по всем полям или по конкретному полю (`field:value`)
- Сортировка по колонкам
- Сохранение порядка колонок из исходного файла

**Редактирование записи:**
1. Загружается запись по ID
2. Отображается форма с полями
3. JSON поля отображаются в специальном редакторе
4. При сохранении проверяются зависимости
5. Обновляется файл в текущей сессии

**Создание записи:**
1. Отображается пустая форма
2. Заполняются обязательные поля
3. Проверяются зависимости
4. Добавляется запись в конец файла

**Удаление записи:**
1. Проверяются зависимости (если запись используется в других файлах)
2. Показывается предупреждение
3. Удаляется запись из файла

#### 4. Обработка JSON полей

**Определение JSON полей:**
```python
JSON_FIELDS = {
    "CONTEST-DATA": ["CONTEST_FEATURE", "CONTEST_PERIOD", "BUSINESS_BLOCK"],
    "TOURNAMENT-SCHEDULE": ["TARGET_TYPE", "FILTER_PERIOD_ARR"],
    "INDICATOR": ["INDICATOR_FILTER"],
    "GROUP": ["GROUP_VALUE"],
    "REWARD": ["REWARD_ADD_DATA"]
}
```

**Редактирование JSON:**
- Отдельный редактор для JSON полей
- Валидация JSON структуры
- Поддержка зависимостей (например, структура `REWARD_ADD_DATA` зависит от `REWARD_TYPE`)
- Автодополнение полей и значений

#### 5. Зависимости между файлами

```python
FILE_DEPENDENCIES = {
    "GROUP": {"parent": "CONTEST-DATA", "parent_key": "CONTEST_CODE", "child_key": "CONTEST_CODE"},
    "INDICATOR": {"parent": "CONTEST-DATA", "parent_key": "CONTEST_CODE", "child_key": "CONTEST_CODE"},
    "REWARD-LINK": {"parent": "REWARD", "parent_key": "REWARD_CODE", "child_key": "REWARD_CODE"},
    # ...
}
```

При удалении записи проверяется:
- Используется ли она в дочерних файлах
- Показывается список зависимых записей
- Предлагается удалить зависимые записи

### Логирование админ-панели

**Серверные логи:**
- Формат: `LOGS_DEBUG_admin_panel_YYYYMMDD_HHMM.log`
- Расположение: `LOGS/`
- Уровни: DEBUG (файл), INFO (консоль)

**Клиентские логи:**
- Консоль браузера (F12)
- Логирование всех API запросов
- Детали ошибок

---

## Техническое задание

### Требования к main.py

1. **Чтение данных:**
   - Поддержка CSV с разделителем ";"
   - Кодировка UTF-8
   - Автоматическое определение файлов по дате

2. **Обработка данных:**
   - Объединение данных по правилам `MERGE_FIELDS`
   - Проверка дубликатов по правилам `CHECK_DUPLICATES`
   - Сохранение исходного порядка колонок

3. **Запись результатов:**
   - Excel файл с несколькими листами
   - Цветовая маркировка дубликатов
   - Сохранение всех исходных данных

4. **Логирование:**
   - DEBUG уровень в файл
   - INFO уровень в консоль
   - Формат с указанием функции

### Требования к админ-панели

1. **Функциональность:**
   - Просмотр всех файлов через вкладки
   - CRUD операции для всех записей
   - Редактирование JSON полей
   - Управление сессиями редактирования

2. **Интерфейс:**
   - Современный дизайн
   - Адаптивная верстка
   - Удобная навигация

3. **Валидация:**
   - Проверка обязательных полей
   - Проверка зависимостей
   - Валидация JSON

4. **Безопасность:**
   - Работа только с копиями файлов
   - Резервное копирование
   - Изоляция сессий

---

## Анализ входных данных

### Структура файлов

Все файлы имеют структуру CSV с разделителем ";" и кодировкой UTF-8.

### JSON поля

В 5 файлах обнаружено 8 JSON полей:

1. **CONTEST-DATA:**
   - `CONTEST_FEATURE` - объект с признаками конкурса
   - `CONTEST_PERIOD` - массив периодов
   - `BUSINESS_BLOCK` - массив строк

2. **TOURNAMENT-SCHEDULE:**
   - `TARGET_TYPE` - объект с `seasonCode`
   - `FILTER_PERIOD_ARR` - массив объектов

3. **INDICATOR:**
   - `INDICATOR_FILTER` - массив объектов

4. **GROUP:**
   - `GROUP_VALUE` - массив чисел или строка

5. **REWARD:**
   - `REWARD_ADD_DATA` - объект (структура зависит от `REWARD_TYPE`)

### Зависимости между файлами

- **GROUP** → **CONTEST-DATA** (по `CONTEST_CODE`)
- **INDICATOR** → **CONTEST-DATA** (по `CONTEST_CODE`)
- **TOURNAMENT-SCHEDULE** → **CONTEST-DATA** (по `CONTEST_CODE`)
- **REPORT** → **TOURNAMENT-SCHEDULE** (по `TOURNAMENT_CODE`, `CONTEST_CODE`)
- **REWARD-LINK** → **REWARD** (по `REWARD_CODE`)
- **REWARD-LINK** → **CONTEST-DATA** (по `CONTEST_CODE`)
- **REWARD-LINK** → **GROUP** (по `CONTEST_CODE`, `GROUP_CODE`)

### Многострочные поля

- **REWARD-LINK.GROUP_CODE** - список значений через запятую

---

## Установка и запуск

### Требования

- Python 3.8+
- pip
- Виртуальное окружение (рекомендуется)

### Установка main.py

```bash
# Создание виртуального окружения
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows

# Установка зависимостей
pip install pandas openpyxl

# Запуск
python main.py
```

### Установка админ-панели

```bash
# Переход в каталог админ-панели
cd admin_panel

# Создание виртуального окружения (если нужно)
python3 -m venv venv
source venv/bin/activate

# Установка зависимостей
pip install -r requirements.txt

# Запуск
python app.py
# или
./start.sh
```

Админ-панель будет доступна по адресу: `http://localhost:5001`

---

## Логирование

### Формат логов

**DEBUG уровень (в файл):**
```
2025-11-14 03:02:51,034 | DEBUG | __main__ | <module> | Запуск сервера админ-панели... [class: None | def: <module>]
```

**INFO уровень (в консоль):**
```
2025-11-14 03:02:51,034 | INFO | __main__ | <module> | Запуск сервера админ-панели...
```

### Именование файлов логов

- `main.py`: `LOGS_DEBUG_YYYYMMDD_HH_MM.log`
- `admin_panel`: `LOGS_DEBUG_admin_panel_YYYYMMDD_HHMM.log`

### Расположение

Все логи сохраняются в каталоге `LOGS/`

---

## История версий

### Версия 1.0 (Текущая)

**Основные изменения:**
- Реализована основная программа обработки данных (`main.py`)
- Создана админ-панель для редактирования данных
- Настроено логирование с двумя уровнями
- Реализована проверка дубликатов
- Добавлена поддержка JSON полей
- Реализовано управление сессиями редактирования

**Исправленные проблемы:**
- Исправлен порядок колонок в админ-панели
- Добавлено детальное логирование ошибок
- Исправлена обработка JSON полей
- Улучшена валидация данных
- Исправлена работа с зависимостями между файлами

**Оптимизации:**
- Удалены неиспользуемые функции создания SUMMARY листов
- Улучшена производительность чтения CSV
- Оптимизирована работа с большими файлами

---

## Контакты и поддержка

Для вопросов и предложений обращайтесь к разработчику проекта.

---

*Документация обновлена: 2025-11-14*
