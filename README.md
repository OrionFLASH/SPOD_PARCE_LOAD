
---

# SPOD PROM DATA TOOL

## Описание

**SPOD PROM DATA TOOL** — профессиональный Python-инструмент для автоматизированной интеграции, сверки, агрегации и анализа отчётных выгрузок по конкурсам, наградам и показателям. Позволяет гибко объединять любые источники, формировать универсальные сводные таблицы с подгрузкой любых полей по одиночным и составным ключам, разворачивать вложенные JSON-структуры любой глубины, а также обеспечивает прозрачное и масштабируемое логирование.

---

## Основные функциональные возможности

* **Автоматическая загрузка** произвольного набора CSV-файлов по единому конфигу.
* **Итоговый лист SUMMARY** с гибкой подгрузкой полей по ключам любой сложности.
* **Универсальные объединения (join)** по ключам (любое число ключей, любая комбинация).
* **Автоматическое разворачивание всех вложенных JSON-полей** (любая глубина, любой формат).
* **Уникальный алгоритм автоопределения и разворота JSON-колонок:** разворачиваются все найденные JSON-структуры без ручного перечисления.
* **Вложенное разворачивание:** например, `ADD_DATA => getCondition => employeeRating`.
* **Гибкая архитектура конфигурации**: вся логика (структура файлов, join, агрегация) задаётся только в переменных-конфигах — ни одна функция не требует изменений при добавлении новых связей/листов.
* **Подробное унифицированное логирование** с контролем уровня и шаблонными сообщениями, поддержка append логов по дате.
* **Кроссплатформенность**: поддержка путей для MacOS, Linux и Windows.

---

## Структура проекта

```
main.py
DIR_INPUT/
    (CSV-файлы)
DIR_OUTPUT/
    (Excel-отчёты)
DIR_LOGS/
    (логи исполнения)
```

---

## Основные переменные и константы

### INPUT\_FILES

Массив словарей, каждый элемент задаёт параметры одного файла (имя, имя листа, ширина колонок, область закрепления):

```python
INPUT_FILES = [
    {
        "file": "CONTEST-DATA (PROM) 2025-07-14 v0",
        "sheet": "CONTEST-DATA",
        "max_col_width": 120,
        "freeze": "C2"
    },
    # ...
]
```

*Количество, имена и параметры файлов настраиваются свободно.*

---

### SUMMARY\_SHEET

Параметры итогового листа (имя, ширина, freeze):

```python
SUMMARY_SHEET = {
    "sheet": "SUMMARY",
    "max_col_width": 70,
    "freeze": "F2"
}
```

---

### MERGE\_FIELDS

Список join-правил для SUMMARY и любых листов: для каждого поля указывается источник (`sheet_src`), ключ(и) в источнике (`src_key`), ключ(и) в целевом листе (`dst_key`), список полей (`column`). Любое количество join-правил.

```python
MERGE_FIELDS = [
    {
        "sheet_src": "CONTEST-DATA",
        "sheet_dst": "SUMMARY",
        "src_key": ["CONTEST_CODE"],
        "dst_key": ["CONTEST_CODE"],
        "column": ["FULL_NAME", ...],
        "mode": "value"
    },
    ...
]
```

### PREFIX_* константы

Основные префиксы, используемые при разворачивании JSON и формировании колонок:

```python
PREFIX_CONTEST_FEATURE = "CONTEST_FEATURE"
PREFIX_ADD_DATA = "ADD_DATA"
PREFIX_REWARD_LINK = "REWARD_LINK => "
COL_REWARD_LINK_CONTEST_CODE = f"{PREFIX_REWARD_LINK}CONTEST_CODE"
```

Используйте их для единообразия имен полей и настройки MERGE_FIELDS.

---

### Логирование

* **LOG\_LEVEL** — уровень (`"DEBUG"` или `"INFO"`).
* **LOG\_MESSAGES** — словарь шаблонов для унификации логов.
* Каждый запуск пишет лог в файл по дате (`LOGS_YYYY-MM-DD.log`).

Примеры шаблонов:

```python
LOG_MESSAGES["func_start"] = "[START] {func} {params}"
LOG_MESSAGES["excel_path"] = "Excel file: {path}"
```

Все логи строятся только через эти шаблоны.

---

## Основные функции

### setup\_logger()

Инициализирует logging: вывод в файл и консоль, имя файла — по дате, режим — дописывание (append).
**Если функция уже инициализирована — не добавляет хэндлеры повторно.**

---

### read\_csv\_file(file\_path)

Загружает CSV-файл с разделителем `;`, кодировка `utf-8`, все поля — строки.
Логирует успешную загрузку и ошибки.

---

### safe\_json\_loads(s)

Корректно парсит строки с невалидными кавычками (`"""` → `"`), всегда возвращает dict/list или None.
Используется во всех местах разбора JSON (универсально и автоматически).
Дополнительно поддерживает фигурные кавычки, одиночные кавычки и удаляет
лишние запятые в конце объектов. При невозможности разбора пытается
использовать `ast.literal_eval`.

**Пример использования:**

```python
obj = safe_json_loads(val)
```

---

### auto\_flatten\_all\_json\_columns(df, sheet)


**Разворачивание JSON**

Алгоритм автоматически применяет `flatten_json_column_recursive` ко всем колонкам,
указанным в `JSON_COLUMNS`. Он поддерживает вложенные объекты любой глубины и
корректно формирует префиксы вида `"ADD_DATA => ..."` или `"CONTEST_FEATURE => ..."`.
Функция берёт на себя исправление невалидных строк и исключение дублей.

---

### flatten\_json\_column\_recursive(df, column, prefix=None, ...)

Рекурсивно разворачивает JSON-строку в колонке, поддерживает вложенные словари, списки, массивы объектов.
Используется автоматически для всех колонок из `JSON_COLUMNS`.

---


### add\_fields\_to\_sheet(df\_base, df\_ref, src\_keys, dst\_keys, columns, ...)

Универсальный join любых полей по любым ключам, включая составные.

---

### build\_summary\_sheet(dfs, params\_summary, merge\_fields)

Строит итоговый лист SUMMARY:

* Формирует каркас по всем возможным сочетаниям ключей.
* Подтягивает все требуемые поля по правилам merge\_fields.
* Формирует сводную таблицу и логирует процесс.

---

### mark\_duplicates(df, key\_cols, ...)

Маркирует дубли в DataFrame по любому сочетанию ключей.

---

### write\_to\_excel(sheets\_data, output\_path)

Записывает все датафреймы на отдельные листы Excel, применяет форматирование, закрепление, сортировку.

---

### main()

**Пошаговый сценарий:**

1. Настройка логирования.
2. Загрузка файлов в DataFrame.
3. Полный авторазворот всех JSON-полей (любая вложенность).
4. Подгрузка дополнительных колонок через универсальный join.
5. Формирование итогового листа по гибким join-правилам.
6. Проверка дублей.
7. Запись результата в Excel.
8. Финальный лог с деталями по времени, числу строк, файлам.

---

## Пример работы с вложенным JSON

**REWARD\_ADD\_DATA** содержит JSON с полем `getCondition`, внутри которого также JSON (например, `nonRewards`, `employeeRating`).
Скрипт развернёт автоматически:

* все ключи `ADD_DATA => ...`
* все ключи `ADD_DATA => getCondition => ...`
* все ключи внутри `ADD_DATA => getCondition => nonRewards => ...`
* все ключи внутри `ADD_DATA => getCondition => employeeRating => ...`
* ...любой уровень вложенности

**Пример:**

| REWARD\_ADD\_DATA                                                                                             | ... |
| ------------------------------------------------------------------------------------------------------------- | --- |
| {"getCondition": {"nonRewards": \[{"nonRewardCode": "ITEM\_02"}], "employeeRating": {"minRatingBANK": "10"}}} | ... |

Будут созданы поля:

* `ADD_DATA => getCondition => nonRewards => [0] => nonRewardCode`
* `ADD_DATA => getCondition => employeeRating => minRatingBANK`

---

## Пример вызова

```bash
python main.py
```

Результат: Excel-файл в `DIR_OUTPUT` и лог-файл в `DIR_LOGS`.

---

## Добавление новых связей, вложенных полей, листов

1. Описать новый источник или лист в `INPUT_FILES`.
2. Добавить join-правило в `MERGE_FIELDS` — больше ничего менять не требуется.
3. Для вложенных JSON — ничего добавлять не требуется, auto\_flatten\_all\_json\_columns всё обработает автоматически.

---

## Версии и изменения

* **v1.0** — базовая агрегация, Excel-вывод.
* **v1.1** — разворачивание JSON.
* **v1.2** — генерация SUMMARY по ключам.
* **v1.3** — универсальные join'ы.
* **v1.4** — расширяемая архитектура, логирование, форматирование.
* **v1.5** — кроссплатформенность, новые правила объединения, стабильность, обработка отсутствующих ключей.
* **v1.6** (текущая):

  * Полная поддержка вложенных JSON (getCondition, nonRewards, employeeRating и др.).
  * Новый алгоритм: автоматический поиск и разворот всех JSON-колонок любой глубины.
  * safe\_json\_loads для гарантированной корректной обработки невалидных строк.
  * Универсальный алгоритм сбора всех возможных комбинаций ключей.
  * Упрощённое масштабирование — добавление новых связей и файлов без изменений кода.
  * Поддержка append-логов, расширенные шаблоны сообщений.

---

## Требования

* Python 3.8+
* pandas
* openpyxl

---

## Техническое задание (актуальная редакция)

1. Программа читает файлы из INPUT\_FILES, полностью автоматически разворачивает вложенные JSON-структуры любой глубины по всем найденным колонкам.
2. Итоговый лист строится по гибко настраиваемым правилам MERGE\_FIELDS, поддерживается любая комбинация и количество ключей.
3. Логика подгрузки и объединения не требует изменений функций — только добавление/изменение описаний join-правил.
4. Лог-файлы ведутся по дате, накапливают все логи запусков.
5. Все действия (от загрузки до join и записи Excel) логируются по унифицированным шаблонам.
6. Для отсутствующих данных всегда выводится "-".
7. Кроссплатформенность: работа на MacOS, Linux, Windows, любые пути.
8. Для всех невалидных JSON-строк выполняется авто-исправление кавычек и структур (safe\_json\_loads).
9. Структура кода позволяет масштабировать проект без изменений функций (только правка конфига и merge\_fields).

---

**Если нужны отдельные блоки примеров (main, примеры функций) или описание паттернов добавления полей — уточни формат, пришлю отдельным блоком.**
