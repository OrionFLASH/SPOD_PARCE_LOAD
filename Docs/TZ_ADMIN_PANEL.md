# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## Административная панель для редактирования данных SPOD

**Версия:** 1.0  
**Дата:** 2025-11-14  
**Статус:** Требуется разработка

---

## 1. ОБЩЕЕ ОПИСАНИЕ

### 1.1. Назначение системы

Административная панель предназначена для управления данными системы SPOD (Система поддержки образовательных данных) через веб-интерфейс. Система позволяет:
- Просматривать данные из CSV файлов в структурированном виде
- Редактировать существующие записи
- Добавлять новые записи с автоматической синхронизацией зависимых файлов
- Удалять записи с каскадным удалением зависимых данных
- Редактировать JSON поля через отдельные формы

### 1.2. Целевая аудитория

- Администраторы системы SPOD
- Операторы, работающие с данными конкурсов
- Технические специалисты, настраивающие параметры системы

### 1.3. Технические требования

- Веб-интерфейс (рекомендуется React/Vue.js или аналогичный фреймворк)
- Backend API (рекомендуется Python FastAPI/Flask или Node.js)
- База данных для хранения данных (опционально, можно работать напрямую с CSV)
- Система валидации данных
- Механизм синхронизации изменений между связанными файлами

---

## 2. АНАЛИЗ СТРУКТУРЫ ДАННЫХ

### 2.1. Файлы данных

Система работает со следующими CSV файлами (разделитель `;`):

#### 2.1.1. CONTEST-DATA (Основной файл)
**Файл:** `CONTEST-DATA (PROM) YYYY-MM-DD vN.csv`  
**Колонки (25):**
- `CONTEST_CODE` - Код конкурса (ключевое поле, уникальный идентификатор)
- `FULL_NAME` - Полное наименование конкурса
- `CREATE_DT` - Дата создания
- `CLOSE_DT` - Дата закрытия
- `BUSINESS_STATUS` - Бизнес-статус (список: АКТИВНЫЙ, АРХИВНЫЙ)
- `CONTEST_TYPE` - Тип конкурса (список: ИНДИВИДУАЛЬНЫЙ НАКОПИТЕЛЬНЫЙ, ТУРНИРНЫЙ, ИНДИВИДУАЛЬНЫЙ)
- `CONTEST_DESCRIPTION` - Описание конкурса
- `CONTEST_FEATURE` - **JSON поле** - Признаки конкурса (см. раздел 2.3.1)
- `CONTEST_PERIOD` - **JSON поле** - Период конкурса (см. раздел 2.3.2)
- `BUSINESS_BLOCK` - **JSON поле** - Бизнес-блок (см. раздел 2.3.3)
- `SHOW_INDICATOR` - Показывать индикатор
- `PRODUCT_GROUP` - Группа продукта
- `PRODUCT` - Продукт
- `CONTEST_SUBJECT` - Предмет конкурса
- `FACTOR_MARK_TYPE` - Тип оценки фактора
- `CONTEST_INDICATOR_METHOD` - Метод индикатора конкурса
- `CONTEST_FACTOR_METHOD` - Метод фактора конкурса
- `PLAN_METHOD_CODE` - Код метода плана
- `PLAN_MOD_METOD` - Метод модификации плана
- `PLAN_MOD_VALUE` - Значение модификации плана
- `FACTOR_MATCH` - Соответствие фактора
- `CONTEST_PERIOD` - Период конкурса
- `TARGET_TYPE` - Тип цели (список: ПРОМ, ТЕСТ)
- `SOURCE_UPD_FREQUENCY` - Частота обновления источника
- `CALC_TYPE` - Тип расчета (список: 1, 0)
- `BUSINESS_BLOCK` - Бизнес-блок
- `FACT_POST_PROCESSING` - Постобработка факта

**Связи:**
- Связан с GROUP через `CONTEST_CODE`
- Связан с INDICATOR через `CONTEST_CODE`
- Связан с TOURNAMENT-SCHEDULE через `CONTEST_CODE`
- Связан с REWARD-LINK через `CONTEST_CODE`

#### 2.1.2. GROUP
**Файл:** `GROUP (PROM) YYYY-MM-DD vN.csv`  
**Колонки (8):**
- `CONTEST_CODE` - Код конкурса (внешний ключ → CONTEST-DATA)
- `GROUP_CODE` - Код группы
- `GROUP_VALUE` - **JSON поле** - Значение группы (см. раздел 2.3.7) - может быть массивом чисел или строкой
- `GET_CALC_METHOD` - Метод расчета получения (список: 1, 2, 3)
- `GET_CALC_CRITERION` - Критерий расчета получения
- `ADD_CALC_CRITERION` - Дополнительный критерий расчета
- `ADD_CALC_CRITERION_2` - Дополнительный критерий расчета 2
- `BASE_CALC_CODE` - Базовый код расчета

**Связи:**
- Зависит от CONTEST-DATA (CONTEST_CODE)
- Связан с REWARD-LINK через `CONTEST_CODE` + `GROUP_CODE`

#### 2.1.3. INDICATOR
**Файл:** `INDICATOR (PROM) YYYY-MM-DD vN.csv`  
**Колонки (16):**
- `CONTEST_CODE` - Код конкурса (внешний ключ → CONTEST-DATA)
- `INDICATOR_CALC_TYPE` - Тип расчета индикатора
- `INDICATOR_ADD_CALC_TYPE` - Дополнительный тип расчета индикатора
- `FULL_NAME` - Полное наименование
- `INDICATOR_CODE` - Код индикатора
- `INDICATOR_AGG_FUNCTION` - Функция агрегации индикатора
- `INDICATOR_WEIGHT` - Вес индикатора
- `INDICATOR_OBJECT` - Объект индикатора
- `INDICATOR_MARK_TYPE` - Тип оценки индикатора
- `INDICATOR_MATCH` - Соответствие индикатора
- `INDICATOR_VALUE` - Значение индикатора
- `CONTEST_CRITERION` - Критерий конкурса
- `INDICATOR_FILTER` - **JSON поле** - Фильтр индикатора (см. раздел 2.3.6)
- `CONTESTANT_SELECTION` - Выбор участника
- `CALC_TYPE` - Тип расчета
- `N` - Номер

**Связи:**
- Зависит от CONTEST-DATA (CONTEST_CODE)

#### 2.1.4. REWARD
**Файл:** `REWARD (PROM) YYYY-MM-DD vN.csv`  
**Колонки (7):**
- `REWARD_CODE` - Код награды (ключевое поле, уникальный идентификатор)
- `REWARD_TYPE` - Тип награды (список: ITEM, BADGE, LABEL, CRYSTAL)
- `FULL_NAME` - Полное наименование
- `REWARD_DESCRIPTION` - Описание награды
- `REWARD_CONDITION` - Условие награды
- `REWARD_COST` - Стоимость награды
- `REWARD_ADD_DATA` - **JSON поле** - Дополнительные данные награды (см. раздел 2.3)

**Связи:**
- Связан с REWARD-LINK через `REWARD_CODE`

#### 2.1.5. TOURNAMENT-SCHEDULE
**Файл:** `TOURNAMENT-SCHEDULE (PROM) YYYY-MM-DD vN.csv`  
**Колонки (15):**
- `TOURNAMENT_CODE` - Код турнира (ключевое поле)
- `PERIOD_TYPE` - Тип периода
- `START_DT` - Дата начала
- `END_DT` - Дата окончания
- `RESULT_DT` - Дата результатов
- `PLAN_PERIOD_START_DT` - Плановая дата начала периода
- `PLAN_PERIOD_END_DT` - Плановая дата окончания периода
- `CRITERION_MARK_TYPE` - Тип оценки критерия
- `CRITERION_MARK_VALUE` - Значение оценки критерия
- `FILTER_PERIOD_ARR` - Массив фильтров периода
- `TOURNAMENT_STATUS` - Статус турнира (список: УДАЛЕН, ЗАВЕРШЕН, АКТИВНЫЙ, ОТМЕНЕН, ПОДВЕДЕНИЕ ИТОГОВ)
- `CONTEST_CODE` - Код конкурса (внешний ключ → CONTEST-DATA)
- `TARGET_TYPE` - **JSON поле** - Тип цели (см. раздел 2.3.4)
- `FILTER_PERIOD_ARR` - **JSON поле** - Массив фильтров периода (см. раздел 2.3.5)
- `CALC_TYPE` - Тип расчета (список: 1, 3, 0)
- `TRN_INDICATOR_FILTER` - Фильтр индикатора турнира

**Связи:**
- Зависит от CONTEST-DATA (CONTEST_CODE)
- Связан с REPORT через `TOURNAMENT_CODE` + `CONTEST_CODE`

#### 2.1.6. REPORT
**Файл:** `REPORT (PROM-KMKKSB) YYYY-MM-DD vN (correct).csv`  
**Колонки (7):**
- `MANAGER_PERSON_NUMBER` - Номер сотрудника менеджера
- `CONTEST_CODE` - Код конкурса (внешний ключ → CONTEST-DATA)
- `TOURNAMENT_CODE` - Код турнира (внешний ключ → TOURNAMENT-SCHEDULE)
- `CONTEST_DATE` - Дата конкурса
- `PLAN_VALUE` - Плановое значение
- `FACT_VALUE` - Фактическое значение
- `priority_type` - Тип приоритета

**Связи:**
- Зависит от CONTEST-DATA (CONTEST_CODE)
- Зависит от TOURNAMENT-SCHEDULE (TOURNAMENT_CODE, CONTEST_CODE)

#### 2.1.7. REWARD-LINK
**Файл:** `REWARD-LINK (PROM) YYYY-MM-DD vN.csv`  
**Колонки (3):**
- `CONTEST_CODE` - Код конкурса (внешний ключ → CONTEST-DATA)
- `GROUP_CODE` - Код группы (внешний ключ → GROUP)
- `REWARD_CODE` - Код награды (внешний ключ → REWARD)

**Связи:**
- Зависит от CONTEST-DATA (CONTEST_CODE)
- Зависит от GROUP (CONTEST_CODE, GROUP_CODE)
- Зависит от REWARD (REWARD_CODE)

### 2.2. Схема связей между файлами

```
CONTEST-DATA (основной)
    ├── GROUP (CONTEST_CODE)
    │   └── REWARD-LINK (CONTEST_CODE, GROUP_CODE)
    ├── INDICATOR (CONTEST_CODE)
    ├── TOURNAMENT-SCHEDULE (CONTEST_CODE)
    │   └── REPORT (TOURNAMENT_CODE, CONTEST_CODE)
    └── REWARD-LINK (CONTEST_CODE)
        └── REWARD (REWARD_CODE)
```

**Правила каскадных операций:**
- При удалении CONTEST-DATA → удаляются все связанные записи в GROUP, INDICATOR, TOURNAMENT-SCHEDULE, REWARD-LINK, REPORT
- При удалении GROUP → удаляются связанные записи в REWARD-LINK
- При удалении TOURNAMENT-SCHEDULE → удаляются связанные записи в REPORT
- При удалении REWARD → удаляются связанные записи в REWARD-LINK

### 2.3. JSON поля

#### 2.3.1. CONTEST_FEATURE (CONTEST-DATA)

**Тип:** JSON объект  
**Структура:** Объект с произвольными ключами

**Известные ключи (на основе анализа кода):**
- `businessBlock` - Бизнес-блок
- `feature` - Признак
- `momentRewarding` - Момент награждения
- `vid` - Вид
- `tournamentStartMailing` - Рассылка начала турнира
- `tournamentEndMailing` - Рассылка окончания турнира
- `tournamentRewardingMailing` - Рассылка награждения турнира
- `tournamentLikeMailing` - Рассылка лайков турнира
- `tournamentListMailing` - Рассылка списка турнира
- `persomanNumberVisible` - Видимость номера сотрудника
- `persomanNumberHidden` - Скрытие номера сотрудника
- `gosbVisible` - Видимость ГОСБ
- `gosbHidden` - Скрытие ГОСБ
- `tbVisible` - Видимость ТБ
- `tbHidden` - Скрытие ТБ
- `minNumber` - Минимальное число
- `capacity` - Вместимость

**Особенности редактирования:**
- Каждый ключ редактируется отдельно
- Значения могут быть разных типов (строка, число, булево)
- При сохранении все ключи объединяются в один JSON объект

#### 2.3.2. CONTEST_PERIOD (CONTEST-DATA)

**Тип:** JSON массив  
**Структура:** Массив объектов или пустой массив `[]`

**Структура элемента массива (если не пустой):**
- Может содержать объекты с информацией о периодах
- Пример: `[{"period_code": 0, "criterion_mark_type": ">", "criterion_mark_value": 0}]`

**Особенности редактирования:**
- Редактирование как массив объектов
- Возможность добавления/удаления элементов массива
- Каждый элемент массива редактируется отдельно
- Поддержка пустого массива

#### 2.3.3. BUSINESS_BLOCK (CONTEST-DATA)

**Тип:** JSON массив строк  
**Структура:** Массив строковых значений

**Пример:** `["KMKKSB"]`

**Особенности редактирования:**
- Редактирование как массив строк
- Возможность добавления/удаления элементов
- Каждый элемент - строка

#### 2.3.4. TARGET_TYPE (TOURNAMENT-SCHEDULE)

**Тип:** JSON объект  
**Структура:** Объект с ключом `seasonCode`

**Структура:**
```json
{
  "seasonCode": "SEASON_2025_1"
}
```

**Возможные значения seasonCode:**
- SEASON_2025_1, SEASON_2025_2, SEASON_m_2025_2, SEASON_s_2025
- SEASON_kmsb1_2025, SEASON_rnub_2025, SEASON_2024
- SEASON_m_2024, SEASON_s_2024, NON

**Особенности редактирования:**
- Объект с одним ключом `seasonCode`
- Выпадающий список для выбора значения seasonCode
- Или текстовое поле для ввода произвольного значения

#### 2.3.5. FILTER_PERIOD_ARR (TOURNAMENT-SCHEDULE)

**Тип:** JSON массив объектов  
**Структура:** Массив объектов с информацией о периодах фильтрации

**Структура элемента массива:**
```json
{
  "period_code": 1,
  "criterion_mark_type": ">",
  "criterion_mark_value": 0,
  "start_dt": "2023-06-01",
  "end_dt": "2023-06-30"
}
```

**Поля объекта:**
- `period_code` - Код периода (число)
- `criterion_mark_type` - Тип критерия оценки (строка, например: ">", "<", "=")
- `criterion_mark_value` - Значение критерия оценки (число)
- `start_dt` - Дата начала периода (строка в формате YYYY-MM-DD)
- `end_dt` - Дата окончания периода (строка в формате YYYY-MM-DD)

**Особенности редактирования:**
- Редактирование как массив объектов
- Таблица с возможностью добавления/удаления строк
- Каждая строка - отдельный объект с полями
- Валидация дат (end_dt >= start_dt)

#### 2.3.6. INDICATOR_FILTER (INDICATOR)

**Тип:** JSON массив объектов  
**Структура:** Массив объектов с информацией о фильтрах индикатора

**Структура элемента массива:**
```json
{
  "filtered_attribute_code": "segment",
  "filtered_attribute_type": "STRING",
  "filtered_attribute_value": "..."
}
```

**Поля объекта:**
- `filtered_attribute_code` - Код атрибута фильтрации (строка)
- `filtered_attribute_type` - Тип атрибута (строка, например: "STRING")
- `filtered_attribute_value` - Значение атрибута (строка)

**Особенности редактирования:**
- Редактирование как массив объектов
- Таблица с возможностью добавления/удаления строк
- Каждая строка - отдельный объект с полями

#### 2.3.7. GROUP_VALUE (GROUP)

**Тип:** JSON массив чисел или строка  
**Структура:** Может быть массивом чисел `[38]` или строкой `"*"`

**Примеры:**
- `[38]` - массив с одним числом
- `[40]` - массив с одним числом
- `"*"` - строка (не JSON)

**Особенности редактирования:**
- Поддержка двух режимов: массив чисел или строка
- Если массив - редактирование как массив чисел
- Если строка - обычное текстовое поле
- Автоматическое определение типа при загрузке

#### 2.3.8. REWARD_ADD_DATA (REWARD)

**Тип:** JSON объект  
**Структура:** Объект с произвольными ключами

**Особенности редактирования:**
- Аналогично CONTEST_FEATURE
- Каждый ключ редактируется отдельно
- При сохранении все ключи объединяются в один JSON объект

### 2.4. Поля со списками значений

#### 2.4.1. Списки с фиксированными значениями

**CONTEST-DATA:**
- `BUSINESS_STATUS`: АКТИВНЫЙ, АРХИВНЫЙ
- `CONTEST_TYPE`: ИНДИВИДУАЛЬНЫЙ НАКОПИТЕЛЬНЫЙ, ТУРНИРНЫЙ, ИНДИВИДУАЛЬНЫЙ
- `TARGET_TYPE`: ПРОМ, ТЕСТ
- `CALC_TYPE`: 1, 0

**REWARD:**
- `REWARD_TYPE`: ITEM, BADGE, LABEL, CRYSTAL

**TOURNAMENT-SCHEDULE:**
- `TOURNAMENT_STATUS`: УДАЛЕН, ЗАВЕРШЕН, АКТИВНЫЙ, ОТМЕНЕН, ПОДВЕДЕНИЕ ИТОГОВ
- `CALC_TYPE`: 1, 3, 0

**GROUP:**
- `GET_CALC_METHOD`: 1, 2, 3

#### 2.4.2. Списки с зависимостями

**Зависимые списки (требуют выбор из связанных файлов):**

1. **REWARD-LINK:**
   - `CONTEST_CODE` → выбор из CONTEST-DATA
   - `GROUP_CODE` → выбор из GROUP (фильтр по выбранному CONTEST_CODE)
   - `REWARD_CODE` → выбор из REWARD

2. **REPORT:**
   - `CONTEST_CODE` → выбор из CONTEST-DATA
   - `TOURNAMENT_CODE` → выбор из TOURNAMENT-SCHEDULE (фильтр по выбранному CONTEST_CODE)

3. **GROUP:**
   - `CONTEST_CODE` → выбор из CONTEST-DATA

4. **INDICATOR:**
   - `CONTEST_CODE` → выбор из CONTEST-DATA

5. **TOURNAMENT-SCHEDULE:**
   - `CONTEST_CODE` → выбор из CONTEST-DATA

#### 2.4.3. Списки с проверками

**Проверки уникальности:**
- `CONTEST_CODE` в CONTEST-DATA должен быть уникальным
- `REWARD_CODE` в REWARD должен быть уникальным
- Комбинация `CONTEST_CODE` + `GROUP_CODE` + `GROUP_VALUE` в GROUP должна быть уникальной
- Комбинация `CONTEST_CODE` + `INDICATOR_ADD_CALC_TYPE` в INDICATOR должна быть уникальной
- Комбинация `MANAGER_PERSON_NUMBER` + `TOURNAMENT_CODE` + `CONTEST_CODE` в REPORT должна быть уникальной

**Проверки существования:**
- `CONTEST_CODE` в зависимых файлах должен существовать в CONTEST-DATA
- `TOURNAMENT_CODE` в REPORT должен существовать в TOURNAMENT-SCHEDULE
- `REWARD_CODE` в REWARD-LINK должен существовать в REWARD
- `GROUP_CODE` в REWARD-LINK должен существовать в GROUP для соответствующего CONTEST_CODE

---

## 3. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 3.1. Структура интерфейса

#### 3.1.1. Главная страница

**Компоненты:**
- Верхняя панель навигации с вкладками для каждого файла
- Список доступных файлов в боковом меню
- Область отображения данных выбранного файла
- Панель инструментов (добавить, экспорт, импорт)

**Вкладки:**
1. CONTEST-DATA
2. GROUP
3. INDICATOR
4. REWARD
5. TOURNAMENT-SCHEDULE
6. REPORT
7. REWARD-LINK

#### 3.1.2. Страница редактирования файла

**Компоненты:**
- Таблица с данными (пагинация, сортировка, фильтрация)
- Панель фильтров сверху
- Кнопки действий для каждой строки (редактировать, удалить)
- Кнопка "Добавить новую запись"
- Поиск по всем полям

**Таблица:**
- Колонки соответствуют колонкам CSV файла
- JSON поля отображаются как "[JSON]" с кнопкой редактирования
- Списки значений отображаются как выпадающие списки в режиме просмотра
- Поддержка сортировки по любой колонке
- Поддержка фильтрации по значениям

### 3.2. Формы редактирования

#### 3.2.1. Форма добавления/редактирования записи

**Структура:**
- Группировка полей по логическим блокам
- Валидация на клиенте и сервере
- Подсказки для каждого поля
- Индикация обязательных полей

**Типы полей:**

1. **Текстовое поле:**
   - Для строковых значений
   - Валидация длины, формата (если требуется)

2. **Выпадающий список (фиксированные значения):**
   - Для полей с фиксированным списком значений
   - Примеры: BUSINESS_STATUS, CONTEST_TYPE, REWARD_TYPE

3. **Выпадающий список с зависимостью:**
   - Для внешних ключей
   - Динамическая загрузка значений из связанного файла
   - Фильтрация по зависимым полям
   - Пример: GROUP_CODE зависит от выбранного CONTEST_CODE

4. **Дата:**
   - Для полей типа DATE
   - Календарь для выбора даты
   - Примеры: CREATE_DT, CLOSE_DT, START_DT

5. **Число:**
   - Для числовых значений
   - Валидация диапазона (если требуется)
   - Примеры: REWARD_COST, INDICATOR_WEIGHT

6. **JSON поле:**
   - Отдельная секция формы
   - Кнопка "Редактировать JSON"
   - Открывает модальное окно с формой редактирования JSON

#### 3.2.2. Форма редактирования JSON поля

**Типы JSON полей и их редактирование:**

**1. JSON объект (CONTEST_FEATURE, REWARD_ADD_DATA, TARGET_TYPE):**
- Модальное окно
- Список ключей JSON объекта
- Для каждого ключа:
  - Название ключа (редактируемое)
  - Тип значения (строка, число, булево, объект, массив)
  - Поле ввода значения (зависит от типа)
  - Кнопка удаления ключа
- Кнопка "Добавить новый ключ"
- Кнопки "Сохранить" и "Отмена"
- Валидация JSON структуры
- Предпросмотр итогового JSON

**2. JSON массив объектов (FILTER_PERIOD_ARR, INDICATOR_FILTER):**
- Модальное окно с таблицей
- Каждая строка таблицы - элемент массива (объект)
- Колонки таблицы соответствуют полям объекта
- Кнопка "Добавить строку" - добавляет новый элемент в массив
- Кнопка "Удалить" для каждой строки
- Валидация каждого объекта в массиве
- Предпросмотр итогового JSON

**3. JSON массив чисел (GROUP_VALUE, BUSINESS_BLOCK):**
- Модальное окно со списком
- Каждый элемент списка - число или строка
- Кнопка "Добавить элемент"
- Кнопка "Удалить" для каждого элемента
- Валидация типа данных
- Предпросмотр итогового JSON

**4. JSON массив строк (BUSINESS_BLOCK):**
- Модальное окно со списком
- Каждый элемент списка - строка
- Кнопка "Добавить элемент"
- Кнопка "Удалить" для каждого элемента
- Валидация типа данных
- Предпросмотр итогового JSON

**Общие особенности:**
- Валидация JSON структуры перед сохранением
- Предпросмотр итогового JSON в реальном времени
- Поддержка вложенных объектов и массивов
- Возможность отмены изменений

### 3.3. Операции с данными

#### 3.3.1. Добавление записи

**Процесс:**
1. Пользователь нажимает "Добавить новую запись"
2. Открывается форма с пустыми полями
3. Пользователь заполняет обязательные поля
4. Система валидирует данные
5. При сохранении:
   - Запись добавляется в основной файл
   - Если требуется, создаются связанные записи в зависимых файлах
   - Проверяется уникальность ключевых полей
   - Выполняются проверки целостности данных

**Автоматическое создание зависимых записей:**
- При добавлении CONTEST-DATA → не создаются автоматически
- При добавлении GROUP → проверяется существование CONTEST_CODE
- При добавлении REWARD-LINK → проверяется существование всех внешних ключей

#### 3.3.2. Редактирование записи

**Процесс:**
1. Пользователь нажимает "Редактировать" для строки
2. Открывается форма с заполненными полями
3. Пользователь изменяет нужные поля
4. Система валидирует изменения
5. При сохранении:
   - Обновляется запись в основном файле
   - Если изменены ключевые поля, обновляются связанные записи
   - Проверяется целостность данных

**Особенности:**
- Изменение ключевого поля (например, CONTEST_CODE) требует обновления всех зависимых записей
- Система должна предупреждать о последствиях изменения ключевых полей

#### 3.3.3. Удаление записи

**Процесс:**
1. Пользователь нажимает "Удалить" для строки
2. Система проверяет наличие зависимых записей
3. Если есть зависимости:
   - Показывается предупреждение со списком зависимых записей
   - Пользователь подтверждает каскадное удаление
4. При подтверждении:
   - Удаляется основная запись
   - Удаляются все зависимые записи (каскадное удаление)
   - Проверяется целостность данных

**Правила каскадного удаления:**
- CONTEST-DATA → удаляются GROUP, INDICATOR, TOURNAMENT-SCHEDULE, REWARD-LINK (с этим CONTEST_CODE), REPORT (с этим CONTEST_CODE)
- GROUP → удаляются REWARD-LINK (с этим CONTEST_CODE + GROUP_CODE)
- TOURNAMENT-SCHEDULE → удаляются REPORT (с этим TOURNAMENT_CODE)
- REWARD → удаляются REWARD-LINK (с этим REWARD_CODE)

### 3.4. Валидация данных

#### 3.4.1. Валидация на клиенте

- Проверка обязательных полей
- Проверка формата данных (дата, число, email и т.д.)
- Проверка уникальности ключевых полей (асинхронно)
- Проверка существования внешних ключей (асинхронно)
- Валидация JSON структуры

#### 3.4.2. Валидация на сервере

- Повторная проверка всех правил валидации
- Проверка целостности данных
- Проверка бизнес-правил
- Проверка прав доступа (если реализована система авторизации)

### 3.5. Синхронизация данных

#### 3.5.1. При добавлении записи

**Пример: Добавление CONTEST-DATA**
- Создается запись в CONTEST-DATA
- Никаких автоматических зависимых записей не создается

**Пример: Добавление GROUP**
- Проверяется существование CONTEST_CODE в CONTEST-DATA
- Создается запись в GROUP

**Пример: Добавление REWARD-LINK**
- Проверяется существование CONTEST_CODE в CONTEST-DATA
- Проверяется существование GROUP_CODE в GROUP для данного CONTEST_CODE
- Проверяется существование REWARD_CODE в REWARD
- Создается запись в REWARD-LINK

#### 3.5.2. При изменении записи

**Пример: Изменение CONTEST_CODE в CONTEST-DATA**
- Обновляется запись в CONTEST-DATA
- Обновляются все записи в GROUP с этим CONTEST_CODE
- Обновляются все записи в INDICATOR с этим CONTEST_CODE
- Обновляются все записи в TOURNAMENT-SCHEDULE с этим CONTEST_CODE
- Обновляются все записи в REWARD-LINK с этим CONTEST_CODE
- Обновляются все записи в REPORT с этим CONTEST_CODE

**Пример: Изменение GROUP_CODE в GROUP**
- Обновляется запись в GROUP
- Обновляются все записи в REWARD-LINK с этим CONTEST_CODE + GROUP_CODE

#### 3.5.3. При удалении записи

См. раздел 3.3.3 "Удаление записи"

---

## 4. ОПИСАНИЕ ФОРМ И ПОЛЕЙ

### 4.1. CONTEST-DATA

#### 4.1.1. Форма редактирования

**Блок 1: Основная информация**
- `CONTEST_CODE` (обязательное, текстовое, уникальное)
  - Валидация: не пустое, уникальность проверяется асинхронно
  - Подсказка: "Уникальный код конкурса"
  
- `FULL_NAME` (обязательное, текстовое)
  - Валидация: не пустое, макс. длина 500 символов
  
- `CONTEST_DESCRIPTION` (необязательное, многострочное текстовое)
  - Валидация: макс. длина 2000 символов

**Блок 2: Даты и статусы**
- `CREATE_DT` (обязательное, дата)
  - Календарь для выбора даты и времени
  
- `CLOSE_DT` (необязательное, дата)
  - Календарь для выбора даты и времени
  - Валидация: должна быть >= CREATE_DT
  
- `BUSINESS_STATUS` (обязательное, выпадающий список)
  - Значения: АКТИВНЫЙ, АРХИВНЫЙ
  
- `CONTEST_TYPE` (обязательное, выпадающий список)
  - Значения: ИНДИВИДУАЛЬНЫЙ НАКОПИТЕЛЬНЫЙ, ТУРНИРНЫЙ, ИНДИВИДУАЛЬНЫЙ

**Блок 3: Параметры конкурса**
- `SHOW_INDICATOR` (необязательное, булево)
  
- `PRODUCT_GROUP` (необязательное, текстовое)
  
- `PRODUCT` (необязательное, текстовое)
  
- `CONTEST_SUBJECT` (необязательное, текстовое)
  
- `TARGET_TYPE` (обязательное, выпадающий список)
  - Значения: ПРОМ, ТЕСТ
  
- `CALC_TYPE` (обязательное, выпадающий список)
  - Значения: 1, 0

**Блок 4: Методы и параметры расчета**
- `FACTOR_MARK_TYPE` (необязательное, текстовое)
  
- `CONTEST_INDICATOR_METHOD` (необязательное, текстовое)
  
- `CONTEST_FACTOR_METHOD` (необязательное, текстовое)
  
- `PLAN_METHOD_CODE` (необязательное, текстовое)
  
- `PLAN_MOD_METOD` (необязательное, текстовое)
  
- `PLAN_MOD_VALUE` (необязательное, число)
  
- `FACTOR_MATCH` (необязательное, текстовое)
  
- `CONTEST_PERIOD` (необязательное, текстовое)
  
- `SOURCE_UPD_FREQUENCY` (необязательное, текстовое)
  
- `BUSINESS_BLOCK` (необязательное, текстовое)
  
- `FACT_POST_PROCESSING` (необязательное, текстовое)

**Блок 5: JSON поля**
- `CONTEST_FEATURE` (необязательное, JSON объект)
  - Кнопка "Редактировать JSON"
  - Открывает модальное окно для редактирования структуры JSON (см. раздел 2.3.1)
  
- `CONTEST_PERIOD` (необязательное, JSON массив)
  - Кнопка "Редактировать JSON"
  - Открывает модальное окно для редактирования массива периодов (см. раздел 2.3.2)
  
- `BUSINESS_BLOCK` (необязательное, JSON массив строк)
  - Кнопка "Редактировать JSON"
  - Открывает модальное окно для редактирования массива строк (см. раздел 2.3.3)

#### 4.1.2. Форма редактирования CONTEST_FEATURE

**Модальное окно:**
- Заголовок: "Редактирование CONTEST_FEATURE"
- Список ключей с возможностью редактирования
- Для каждого ключа:
  - Поле "Ключ" (текстовое, редактируемое)
  - Поле "Тип" (выпадающий список: строка, число, булево, объект, массив)
  - Поле "Значение" (зависит от типа)
  - Кнопка "Удалить"
- Кнопка "Добавить ключ"
- Кнопки "Сохранить" и "Отмена"
- Предпросмотр итогового JSON

### 4.2. GROUP

#### 4.2.1. Форма редактирования

**Блок 1: Связь с конкурсом**
- `CONTEST_CODE` (обязательное, выпадающий список с зависимостью)
  - Источник: CONTEST-DATA
  - Загружает список всех CONTEST_CODE из CONTEST-DATA
  - Подсказка: "Выберите конкурс"

**Блок 2: Информация о группе**
- `GROUP_CODE` (обязательное, текстовое)
  - Валидация: не пустое
  - Проверка уникальности комбинации CONTEST_CODE + GROUP_CODE + GROUP_VALUE
  
- `GROUP_VALUE` (обязательное, JSON массив чисел или строка)
  - Кнопка "Редактировать JSON" (если это массив)
  - Может быть массивом чисел `[38]` или строкой `"*"`
  - Валидация: не пустое
  - Проверка уникальности комбинации CONTEST_CODE + GROUP_CODE + GROUP_VALUE (см. раздел 2.3.7)

**Блок 3: Параметры расчета**
- `GET_CALC_METHOD` (обязательное, выпадающий список)
  - Значения: 1, 2, 3
  
- `GET_CALC_CRITERION` (необязательное, текстовое)
  
- `ADD_CALC_CRITERION` (необязательное, текстовое)
  
- `ADD_CALC_CRITERION_2` (необязательное, текстовое)
  
- `BASE_CALC_CODE` (необязательное, текстовое)

### 4.3. INDICATOR

#### 4.3.1. Форма редактирования

**Блок 1: Связь с конкурсом**
- `CONTEST_CODE` (обязательное, выпадающий список с зависимостью)
  - Источник: CONTEST-DATA

**Блок 2: Информация об индикаторе**
- `INDICATOR_ADD_CALC_TYPE` (обязательное, текстовое)
  - Проверка уникальности комбинации CONTEST_CODE + INDICATOR_ADD_CALC_TYPE
  
- `FULL_NAME` (обязательное, текстовое)
  
- `INDICATOR_CODE` (необязательное, текстовое)

**Блок 3: Параметры индикатора**
- `INDICATOR_CALC_TYPE` (необязательное, текстовое)
  
- `INDICATOR_AGG_FUNCTION` (необязательное, текстовое)
  
- `INDICATOR_WEIGHT` (необязательное, число)
  
- `INDICATOR_OBJECT` (необязательное, текстовое)
  
- `INDICATOR_MARK_TYPE` (необязательное, текстовое)
  
- `INDICATOR_MATCH` (необязательное, текстовое)
  
- `INDICATOR_VALUE` (необязательное, текстовое)
  
- `CONTEST_CRITERION` (необязательное, текстовое)
  
- `INDICATOR_FILTER` (необязательное, JSON массив объектов)
  - Кнопка "Редактировать JSON"
  - Открывает модальное окно для редактирования массива фильтров (см. раздел 2.3.6)
  
- `CONTESTANT_SELECTION` (необязательное, текстовое)
  
- `CALC_TYPE` (необязательное, текстовое)
  
- `N` (необязательное, число)

### 4.4. REWARD

#### 4.4.1. Форма редактирования

**Блок 1: Основная информация**
- `REWARD_CODE` (обязательное, текстовое, уникальное)
  - Валидация: не пустое, уникальность проверяется асинхронно
  
- `REWARD_TYPE` (обязательное, выпадающий список)
  - Значения: ITEM, BADGE, LABEL, CRYSTAL
  
- `FULL_NAME` (обязательное, текстовое)
  
- `REWARD_DESCRIPTION` (необязательное, многострочное текстовое)
  
- `REWARD_CONDITION` (необязательное, текстовое)
  
- `REWARD_COST` (необязательное, число)
  - Валидация: >= 0

**Блок 2: JSON поле**
- `REWARD_ADD_DATA` (необязательное, JSON)
  - Кнопка "Редактировать JSON"
  - Аналогично CONTEST_FEATURE

### 4.5. TOURNAMENT-SCHEDULE

#### 4.5.1. Форма редактирования

**Блок 1: Связь с конкурсом**
- `CONTEST_CODE` (обязательное, выпадающий список с зависимостью)
  - Источник: CONTEST-DATA

**Блок 2: Основная информация**
- `TOURNAMENT_CODE` (обязательное, текстовое, уникальное)
  - Валидация: не пустое, уникальность

**Блок 3: Даты**
- `START_DT` (обязательное, дата)
  
- `END_DT` (обязательное, дата)
  - Валидация: >= START_DT
  
- `RESULT_DT` (необязательное, дата)
  
- `PLAN_PERIOD_START_DT` (необязательное, дата)
  
- `PLAN_PERIOD_END_DT` (необязательное, дата)
  - Валидация: >= PLAN_PERIOD_START_DT (если указано)

**Блок 4: Параметры**
- `PERIOD_TYPE` (необязательное, текстовое)
  
- `TOURNAMENT_STATUS` (обязательное, выпадающий список)
  - Значения: УДАЛЕН, ЗАВЕРШЕН, АКТИВНЫЙ, ОТМЕНЕН, ПОДВЕДЕНИЕ ИТОГОВ
  
- `CRITERION_MARK_TYPE` (необязательное, текстовое)
  
- `CRITERION_MARK_VALUE` (необязательное, текстовое)
  
- `FILTER_PERIOD_ARR` (необязательное, текстовое)
  
- `TARGET_TYPE` (необязательное, JSON объект)
  - Кнопка "Редактировать JSON"
  - Открывает модальное окно для редактирования объекта с seasonCode (см. раздел 2.3.4)
  
- `FILTER_PERIOD_ARR` (необязательное, JSON массив объектов)
  - Кнопка "Редактировать JSON"
  - Открывает модальное окно для редактирования массива периодов фильтрации (см. раздел 2.3.5)
  
- `CALC_TYPE` (обязательное, выпадающий список)
  - Значения: 1, 3, 0
  
- `TRN_INDICATOR_FILTER` (необязательное, текстовое)

### 4.6. REPORT

#### 4.6.1. Форма редактирования

**Блок 1: Связи**
- `CONTEST_CODE` (обязательное, выпадающий список с зависимостью)
  - Источник: CONTEST-DATA
  
- `TOURNAMENT_CODE` (обязательное, выпадающий список с зависимостью)
  - Источник: TOURNAMENT-SCHEDULE
  - Фильтр: только турниры с выбранным CONTEST_CODE
  - Подсказка: "Сначала выберите CONTEST_CODE"

**Блок 2: Информация о сотруднике**
- `MANAGER_PERSON_NUMBER` (обязательное, текстовое)
  - Проверка уникальности комбинации MANAGER_PERSON_NUMBER + TOURNAMENT_CODE + CONTEST_CODE

**Блок 3: Данные отчета**
- `CONTEST_DATE` (обязательное, дата)
  
- `PLAN_VALUE` (необязательное, число)
  
- `FACT_VALUE` (необязательное, число)
  
- `priority_type` (необязательное, текстовое)

### 4.7. REWARD-LINK

#### 4.7.1. Форма редактирования

**Блок 1: Связи**
- `CONTEST_CODE` (обязательное, выпадающий список с зависимостью)
  - Источник: CONTEST-DATA
  
- `GROUP_CODE` (обязательное, выпадающий список с зависимостью)
  - Источник: GROUP
  - Фильтр: только группы с выбранным CONTEST_CODE
  - Подсказка: "Сначала выберите CONTEST_CODE"
  
- `REWARD_CODE` (обязательное, выпадающий список с зависимостью)
  - Источник: REWARD

**Особенности:**
- Все три поля обязательны
- Проверка существования всех комбинаций
- При изменении CONTEST_CODE обновляется список доступных GROUP_CODE

---

## 5. ТЕХНИЧЕСКИЕ ДЕТАЛИ РЕАЛИЗАЦИИ

### 5.1. Архитектура системы

**Рекомендуемая архитектура:**
- Frontend: React/Vue.js + TypeScript
- Backend: Python FastAPI/Flask или Node.js Express
- Хранение данных: CSV файлы (или миграция на БД)
- Валидация: JSON Schema для структуры данных

### 5.2. API эндпоинты

**Базовые операции:**
- `GET /api/files` - список всех файлов
- `GET /api/files/{file_name}/records` - список записей файла (с пагинацией, фильтрацией, сортировкой)
- `GET /api/files/{file_name}/records/{id}` - получение одной записи
- `POST /api/files/{file_name}/records` - создание новой записи
- `PUT /api/files/{file_name}/records/{id}` - обновление записи
- `DELETE /api/files/{file_name}/records/{id}` - удаление записи

**Специальные операции:**
- `GET /api/files/{file_name}/dependencies/{id}` - получение зависимых записей
- `GET /api/files/{file_name}/lookup/{field}` - получение списка значений для выпадающего списка
- `GET /api/files/{file_name}/lookup/{field}?filter={field}={value}` - получение отфильтрованного списка
- `POST /api/validate` - валидация данных перед сохранением

### 5.3. Обработка JSON полей

**Структура данных:**
```json
{
  "CONTEST_FEATURE": {
    "businessBlock": "string",
    "feature": "string",
    "momentRewarding": "string",
    ...
  }
}
```

**API для JSON:**
- `GET /api/files/{file_name}/records/{id}/json/{field}` - получение JSON поля
- `PUT /api/files/{file_name}/records/{id}/json/{field}` - обновление JSON поля

### 5.4. Синхронизация данных

**Механизм:**
- При изменении ключевого поля система автоматически находит все зависимые записи
- Обновление выполняется в транзакции (если используется БД) или атомарно (для CSV)
- В случае ошибки все изменения откатываются

### 5.5. Валидация

**Правила валидации:**
- Хранятся в конфигурационном файле или БД
- Поддержка кастомных правил для каждого поля
- Проверка на клиенте и сервере

---

## 6. ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ

### 6.1. Сценарий 1: Добавление нового конкурса

1. Пользователь открывает вкладку "CONTEST-DATA"
2. Нажимает "Добавить новую запись"
3. Заполняет форму:
   - CONTEST_CODE: "CONTEST_2025_001"
   - FULL_NAME: "Конкурс на лучшего сотрудника 2025"
   - BUSINESS_STATUS: "АКТИВНЫЙ"
   - CONTEST_TYPE: "ТУРНИРНЫЙ"
   - CREATE_DT: "2025-01-01"
   - ...
4. Нажимает "Редактировать JSON" для CONTEST_FEATURE
5. Добавляет ключи:
   - businessBlock: "PROM"
   - feature: "tournament"
6. Сохраняет форму
7. Система проверяет уникальность CONTEST_CODE
8. Создается новая запись в CONTEST-DATA

### 6.2. Сценарий 2: Добавление группы для конкурса

1. Пользователь открывает вкладку "GROUP"
2. Нажимает "Добавить новую запись"
3. Выбирает CONTEST_CODE из списка (загружаются все конкурсы)
4. Заполняет:
   - GROUP_CODE: "GROUP_A"
   - GROUP_VALUE: "Группа А"
   - GET_CALC_METHOD: "1"
5. Сохраняет
6. Система проверяет существование CONTEST_CODE
7. Система проверяет уникальность комбинации CONTEST_CODE + GROUP_CODE + GROUP_VALUE
8. Создается новая запись в GROUP

### 6.3. Сценарий 3: Удаление конкурса с зависимостями

1. Пользователь открывает вкладку "CONTEST-DATA"
2. Находит запись с CONTEST_CODE = "CONTEST_2025_001"
3. Нажимает "Удалить"
4. Система проверяет зависимости и показывает предупреждение:
   "Удаление этой записи приведет к удалению:
   - 5 записей в GROUP
   - 3 записей в INDICATOR
   - 2 записей в TOURNAMENT-SCHEDULE
   - 10 записей в REWARD-LINK
   - 15 записей в REPORT"
5. Пользователь подтверждает
6. Система удаляет все связанные записи каскадно

---

## 7. ДОПОЛНИТЕЛЬНЫЕ ТРЕБОВАНИЯ

### 7.1. Производительность

- Загрузка списка записей должна выполняться с пагинацией (по 50-100 записей на страницу)
- Поиск и фильтрация должны работать быстро (индексация при необходимости)
- Выпадающие списки должны загружаться асинхронно

### 7.2. Безопасность

- Валидация всех входных данных на сервере
- Защита от SQL-инъекций (если используется БД)
- Защита от XSS атак
- Логирование всех операций изменения данных

### 7.3. Удобство использования

- Интуитивный интерфейс
- Подсказки для всех полей
- Валидация в реальном времени
- Сообщения об ошибках понятны пользователю
- Поддержка отмены операций (undo)

### 7.4. Резервное копирование

- Автоматическое создание резервных копий перед изменением данных
- Возможность восстановления из резервной копии
- История изменений (опционально)

---

## 8. ЭТАПЫ РАЗРАБОТКИ

### Этап 1: Подготовка
- Анализ требований
- Проектирование архитектуры
- Создание макетов интерфейса

### Этап 2: Backend
- Разработка API
- Реализация валидации
- Реализация синхронизации данных

### Этап 3: Frontend
- Разработка интерфейса
- Интеграция с API
- Реализация форм редактирования

### Этап 4: Тестирование
- Модульное тестирование
- Интеграционное тестирование
- Тестирование пользовательского интерфейса

### Этап 5: Развертывание
- Установка на сервер
- Настройка окружения
- Обучение пользователей

---

## 9. ЗАКЛЮЧЕНИЕ

Данное техническое задание описывает полную функциональность административной панели для редактирования данных SPOD. Система должна обеспечивать удобный и безопасный способ управления данными с автоматической синхронизацией между связанными файлами.

**Ключевые особенности:**
- Работа с исходными CSV файлами без дополнительных полей
- Редактирование JSON полей через отдельные формы
- Автоматическая синхронизация зависимых данных
- Каскадное удаление с предупреждениями
- Валидация данных на клиенте и сервере
- Интуитивный интерфейс с вкладками для каждого файла

---

**Версия документа:** 1.0  
**Дата создания:** 2025-11-14  
**Автор:** Система анализа данных SPOD
